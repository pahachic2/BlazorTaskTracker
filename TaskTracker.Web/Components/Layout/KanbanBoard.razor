@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@* Kanban –¥–æ—Å–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç *@

<div class="flex gap-4 p-6 h-full">
    @foreach (var column in Columns)
    {
        <div id="column-@column.Id" class="kanban-column flex-shrink-0 w-80 bg-gray-100 rounded-lg p-4 flex flex-col group">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="flex items-center justify-between mb-4 relative @(IsColumnEditing(column.Id) ? "ring-2 ring-blue-500 rounded bg-blue-50 p-2" : "")">
                <div class="flex items-center space-x-2 flex-1">
                    @if (IsColumnEditing(column.Id))
                    {
                        <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ -->
                        <div class="flex items-center space-x-2 flex-1 inline-edit-enter">
                            <input type="text" 
                                   @bind="editingColumnTitles[column.Id]" 
                                   @onkeypress="@(async (e) => await HandleColumnTitleKeyPress(e, column))"
                                   @onblur="@(async () => await SaveColumnChanges(column))"
                                   @onfocus="@((e) => SelectColumnInputText(e))"
                                   disabled="@IsColumnSaving(column.Id)"
                                   class="flex-1 px-2 py-1 text-lg font-semibold text-gray-700 bg-white border border-blue-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent @(IsColumnSaving(column.Id) ? "opacity-50 cursor-not-allowed" : "")"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏..."
                                   maxlength="100"
                                   @onclick:stopPropagation="true" />
                            @if (IsColumnSaving(column.Id))
                            {
                                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                                <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            }
                            <span class="bg-gray-200 text-gray-600 px-2 py-1 rounded-full text-xs font-medium">
                                @column.Tasks.Count
                            </span>
                        </div>
                    }
                    else
                    {
                        <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ -->
                        <h3 class="font-semibold text-gray-700 text-lg cursor-pointer hover:text-blue-600 transition-colors inline-editable" 
                           @onclick="@(() => StartEditingColumn(column))"
                           @onclick:stopPropagation="true"
                           title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏">
                            @column.Title
                        </h3>
                        <span class="bg-gray-200 text-gray-600 px-2 py-1 rounded-full text-xs font-medium">
                            @column.Tasks.Count
                        </span>
                    }
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) -->
                <button @onclick="@(() => HandleDeleteColumn(column))" @onclick:stopPropagation="true"
                        class="opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                        title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
            <div class="space-y-3 flex-1 overflow-y-auto">
                @foreach (var task in column.Tasks)
                {
                    <div id="task-@task.Id" data-task-id="@task.Id" data-column-id="@column.Id"
                        class="kanban-task bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow group relative @(IsTaskEditing(task.Id) ? "ring-2 ring-blue-500 bg-blue-50" : "")"
                        @onmouseenter="@(() => HandleTaskMouseEnter(task))"
                        @onclick:preventDefault="false" @onclick:stopPropagation="false">

                        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) -->
                        <button @onclick="@(() => HandleDeleteTask(task))" @onclick:stopPropagation="true"
                                class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                                title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>

                        <!-- –û–±–ª–∞—Å—Ç—å –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–¥–∞—á–∏ -->
                        <div @onclick="@(() => HandleTaskClick(task))" class="cursor-pointer">
                            <!-- –¢–µ–≥–∏ –∑–∞–¥–∞—á–∏ -->
                            @if (task.Tags.Any())
                            {
                                <div class="flex flex-wrap gap-1 mb-3">
                                    @foreach (var tag in task.Tags)
                                    {
                                        <span class="@GetTagClasses(tag) px-2 py-1 rounded text-xs font-medium">
                                            @tag
                                        </span>
                                    }
                                </div>
                            }

                            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏ -->
                            @if (IsTaskEditing(task.Id))
                            {
                                <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
                                <div class="mb-2 relative inline-edit-enter">
                                    <input type="text" 
                                           @bind="editingTaskTitles[task.Id]" 
                                           @onkeypress="@(async (e) => await HandleTitleKeyPress(e, task))"
                                           @onblur="@(async () => await SaveTaskChanges(task))"
                                           @onfocus="@((e) => SelectInputText(e))"
                                           disabled="@IsTaskSaving(task.Id)"
                                           class="w-full px-2 py-1 text-sm font-medium text-gray-900 bg-white border border-blue-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent @(IsTaskSaving(task.Id) ? "opacity-50 cursor-not-allowed" : "")"
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."
                                           maxlength="200"
                                           @onclick:stopPropagation="true" />
                                    @if (IsTaskSaving(task.Id))
                                    {
                                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                            <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
                                <h4 class="font-medium text-gray-900 text-sm mb-2 line-clamp-2 cursor-pointer hover:text-blue-600 transition-colors inline-editable" 
                                   @onclick="@(() => StartEditingTask(task))"
                                   @onclick:stopPropagation="true"
                                   title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
                                    @task.Title
                                </h4>
                            }

                            <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
                            @if (!string.IsNullOrEmpty(task.Description))
                            {
                                <p class="text-gray-600 text-xs mb-3 line-clamp-2">
                                    @task.Description
                                </p>
                            }

                            <!-- –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                            <div class="flex items-center justify-between">
                                <!-- –î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                                @if (IsTaskEditing(task.Id))
                                {
                                    <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã -->
                                    <div class="flex items-center space-x-1 inline-edit-enter">
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <input type="date" 
                                               value="@GetEditingTaskDueDateString(task.Id)"
                                               @onchange="@((ChangeEventArgs e) => UpdateEditingTaskDueDate(task.Id, e.Value?.ToString()))"
                                               @onkeypress="@(async (e) => await HandleDateKeyPress(e, task))"
                                               @onblur="@(async () => await SaveTaskChanges(task))"
                                               disabled="@IsTaskSaving(task.Id)"
                                               class="px-1 py-0.5 text-xs border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent bg-white @(IsTaskSaving(task.Id) ? "opacity-50 cursor-not-allowed" : "")"
                                               @onclick:stopPropagation="true" />
                                        <button @onclick="@(async () => await ClearTaskDate(task))" 
                                                @onclick:stopPropagation="true"
                                                disabled="@IsTaskSaving(task.Id)"
                                                class="text-gray-400 hover:text-red-500 transition-colors @(IsTaskSaving(task.Id) ? "opacity-50 cursor-not-allowed" : "")"
                                                title="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞—Ç—É">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                }
                                else if (task.DueDate.HasValue)
                                {
                                    <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞—Ç—ã -->
                                    <div class="flex items-center space-x-1 cursor-pointer hover:text-blue-600 transition-colors inline-editable"
                                         @onclick="@(() => StartEditingTask(task))"
                                         @onclick:stopPropagation="true"
                                         title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã">
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <span class="@GetDueDateClasses(task.DueDate.Value) text-xs">
                                            @task.DueDate.Value.ToString("dd MMM")
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –¥–∞—Ç—ã –Ω–µ—Ç -->
                                    <div class="flex items-center space-x-1 cursor-pointer hover:text-blue-600 transition-colors opacity-50 inline-editable"
                                         @onclick="@(() => StartEditingTask(task))"
                                         @onclick:stopPropagation="true"
                                         title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã">
                                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <span class="text-xs text-gray-400">–î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</span>
                                    </div>
                                }

                                <!-- –ê–≤–∞—Ç–∞—Ä—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π -->
                                @if (task.Assignees.Any())
                                {
                                    <div class="flex -space-x-1">
                                        @foreach (var assignee in task.Assignees.Take(3))
                                        {
                                            <div class="w-6 h-6 rounded-full @GetAssigneeColor(assignee) flex items-center justify-center border-2 border-white text-white text-xs font-medium"
                                                title="@assignee">
                                                @assignee.Substring(0, 1).ToUpper()
                                            </div>
                                        }
                                        @if (task.Assignees.Count > 3)
                                        {
                                            <div class="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center border-2 border-white text-white text-xs font-medium"
                                                title="–ï—â–µ @(task.Assignees.Count - 3)">
                                                +@(task.Assignees.Count - 3)
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
            <button @onclick="@(() => OnAddTaskToColumn.InvokeAsync(column.Id))"
                class="mt-3 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors text-sm">
                + –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
            </button>
        </div>
    }

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ -->
    @if (ShowAddColumnButton)
    {
        <div class="flex-shrink-0 w-80">
            <button @onclick="HandleAddColumn"
                class="w-full h-32 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors flex flex-col items-center justify-center space-y-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
                    </path>
                </svg>
                <span class="text-sm font-medium">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</span>
            </button>
        </div>
    }
</div>

@code {
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    [Parameter] public List<KanbanColumn> Columns { get; set; } = new();
    [Parameter] public bool ShowAddColumnButton { get; set; } = true;

    // –°–æ–±—ã—Ç–∏—è
    [Parameter] public EventCallback<KanbanTask> OnTaskClick { get; set; }
    [Parameter] public EventCallback<string> OnAddTaskToColumn { get; set; }
    [Parameter] public EventCallback OnAddColumn { get; set; }
    [Parameter] public EventCallback<TaskMovedEventArgs> OnTaskMoved { get; set; }
    [Parameter] public EventCallback<KanbanTask> OnTaskDelete { get; set; }
[Parameter] public EventCallback<KanbanColumn> OnColumnDelete { get; set; }
[Parameter] public EventCallback<KanbanTask> OnTaskUpdate { get; set; }
[Parameter] public EventCallback<KanbanColumn> OnColumnUpdate { get; set; }

private bool jsInteropDone = false;

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á
private Dictionary<string, bool> taskEditingStates = new Dictionary<string, bool>();
private Dictionary<string, string> editingTaskTitles = new Dictionary<string, string>();
private Dictionary<string, DateTime?> editingTaskDueDates = new Dictionary<string, DateTime?>();
private Dictionary<string, bool> taskSavingStates = new Dictionary<string, bool>(); // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
private string? currentEditingTaskId = null; // –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
private Dictionary<string, bool> columnEditingStates = new Dictionary<string, bool>();
private Dictionary<string, string> editingColumnTitles = new Dictionary<string, string>();
private Dictionary<string, bool> columnSavingStates = new Dictionary<string, bool>(); // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
private string? currentEditingColumnId = null; // –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    private DotNetObjectReference<KanbanBoard>? dotNetRef;
    private bool isTaskMoving = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Console.WriteLine($"üîÑ BLAZOR: OnAfterRenderAsync –≤—ã–∑–≤–∞–Ω, firstRender: {firstRender}, jsInteropDone: {jsInteropDone}");

        if (firstRender)
        {
            Console.WriteLine("üîÑ BLAZOR: –≠—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...");

            dotNetRef = DotNetObjectReference.Create(this);
            Console.WriteLine("üîÑ BLAZOR: DotNetObjectReference —Å–æ–∑–¥–∞–Ω");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ JavaScript —Ñ—É–Ω–∫—Ü–∏–∏
            try
            {
                var hasWindow = await JSRuntime.InvokeAsync<bool>("eval", "typeof window !== 'undefined'");
                Console.WriteLine($"üîÑ BLAZOR: Window –æ–±—ä–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: {hasWindow}");

                var hasConsole = await JSRuntime.InvokeAsync<bool>("eval", "typeof console !== 'undefined'");
                Console.WriteLine($"üîÑ BLAZOR: Console –æ–±—ä–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: {hasConsole}");

                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
                await JSRuntime.InvokeVoidAsync("console.log", "üîÑ BLAZOR: –¢–µ—Å—Ç –≤—ã–∑–æ–≤–∞ JavaScript –∏–∑ Blazor");

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—à –æ–±—ä–µ–∫—Ç
                var hasKanbanDragDrop = await JSRuntime.InvokeAsync<bool>("eval", "typeof window.kanbanDragDrop !== 'undefined'");
                Console.WriteLine($"üîÑ BLAZOR: kanbanDragDrop –æ–±—ä–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: {hasKanbanDragDrop}");

                if (!hasKanbanDragDrop)
                {
                    Console.WriteLine("‚ùå BLAZOR: kanbanDragDrop –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–∞...");

                    // –ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
                    await JSRuntime.InvokeVoidAsync("eval", @"
if (!window.kanbanDragDrop) {
console.log('üîÑ JS: –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ kanbanDragDrop...');
var script = document.createElement('script');
script.src = 'js/kanban-drag-drop.js';
script.onload = function() { console.log('‚úÖ JS: –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ'); };
script.onerror = function() { console.log('‚ùå JS: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞'); };
document.head.appendChild(script);
}
");

                    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
                    await Task.Delay(1000);

                    hasKanbanDragDrop = await JSRuntime.InvokeAsync<bool>("eval", "typeof window.kanbanDragDrop !== 'undefined'");
                    Console.WriteLine($"üîÑ BLAZOR: –ü–æ—Å–ª–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ kanbanDragDrop –¥–æ—Å—Ç—É–ø–µ–Ω: {hasKanbanDragDrop}");
                }

                if (hasKanbanDragDrop)
                {
                    await InitializeDragAndDrop();
                }
                else
                {
                    Console.WriteLine("‚ùå BLAZOR: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å kanbanDragDrop!");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå BLAZOR: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ JavaScript: {ex.Message}");
            }
        }
        else if (jsInteropDone && !isTaskMoving)
        {
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä, –Ω–æ JS —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω,
            // –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag-and-drop –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
            Console.WriteLine("üîÑ BLAZOR: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag-and-drop –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á...");
            await ReinitializeDragAndDrop();
        }
        else if (isTaskMoving)
        {
            Console.WriteLine("‚è∏Ô∏è BLAZOR: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –∑–∞–¥–∞—á–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è");
        }
    }

    private async Task InitializeDragAndDrop()
    {
        try
        {
            Console.WriteLine("üöÄ BLAZOR: –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é drag-and-drop...");

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag-and-drop –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á –∏ –∫–æ–ª–æ–Ω–æ–∫
            foreach (var column in Columns)
            {
                Console.WriteLine($"üèóÔ∏è BLAZOR: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–∫–∏: {column.Id} —Å {column.Tasks.Count} –∑–∞–¥–∞—á–∞–º–∏");

                // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drop zone –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏
                await JSRuntime.InvokeVoidAsync("kanbanDragDrop.initColumnDropZone", $"column-{column.Id}", column.Id, dotNetRef);

                // –ó–∞—Ç–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á –≤ –∫–æ–ª–æ–Ω–∫–µ
                foreach (var task in column.Tasks)
                {
                    Console.WriteLine($"üéØ BLAZOR: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á–∏: {task.Id} ({task.Title}) –≤ –∫–æ–ª–æ–Ω–∫–µ {column.Id}");
                    await JSRuntime.InvokeVoidAsync("kanbanDragDrop.initTaskDragDrop", $"task-{task.Id}", task.Id, column.Id);
                }
            }

            Console.WriteLine("‚úÖ BLAZOR: Drag-and-drop –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!");
            jsInteropDone = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå BLAZOR: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ drag-and-drop: {ex.Message}");
        }
    }

    private async Task ReinitializeDragAndDrop()
    {
        try
        {
            Console.WriteLine("üîÑ BLAZOR: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag-and-drop...");

            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
            await Task.Delay(100);

            // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag-and-drop –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
            foreach (var column in Columns)
            {
                foreach (var task in column.Tasks)
                {
                    Console.WriteLine($"üîÑ BLAZOR: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á–∏: {task.Id} –≤ –∫–æ–ª–æ–Ω–∫–µ {column.Id}");
                    await JSRuntime.InvokeVoidAsync("kanbanDragDrop.initTaskDragDrop", $"task-{task.Id}", task.Id, column.Id);
                }
            }

            Console.WriteLine("‚úÖ BLAZOR: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag-and-drop –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå BLAZOR: –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ drag-and-drop: {ex.Message}");
        }
    }

    private async Task HandleTaskClick(KanbanTask task)
    {
        Console.WriteLine($"üñ±Ô∏è BLAZOR: –ö–ª–∏–∫ –ø–æ –∑–∞–¥–∞—á–µ: {task.Title}");
        await OnTaskClick.InvokeAsync(task);
    }

    private void HandleTaskMouseEnter(KanbanTask task)
    {
        Console.WriteLine($"üê≠ BLAZOR: –ù–∞–≤–µ–¥–µ–Ω–∏–µ –º—ã—à–∏ –Ω–∞ –∑–∞–¥–∞—á—É: {task.Title} (ID: {task.Id})");
    }

    private async Task HandleAddColumn()
    {
        Console.WriteLine("üî• KANBAN: –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É'");
        if (OnAddColumn.HasDelegate)
        {
            await OnAddColumn.InvokeAsync();
        }
    }

    private async Task HandleDeleteTask(KanbanTask task)
    {
        Console.WriteLine($"üóëÔ∏è KANBAN: –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: {task.Title}");
        if (OnTaskDelete.HasDelegate)
        {
            await OnTaskDelete.InvokeAsync(task);
        }
    }

    private async Task HandleDeleteColumn(KanbanColumn column)
    {
        Console.WriteLine($"üóëÔ∏è KANBAN: –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏: {column.Title}");
        if (OnColumnDelete.HasDelegate)
        {
            await OnColumnDelete.InvokeAsync(column);
        }
    }

    [JSInvokable]
    public async Task OnTaskDropped(string taskId, string fromColumnId, string toColumnId)
    {
        Console.WriteLine($"üéØ BLAZOR: –ü–æ–ª—É—á–µ–Ω drop —Å–æ–±—ã—Ç–∏—è - –∑–∞–¥–∞—á–∞ {taskId} –∏–∑ {fromColumnId} –≤ {toColumnId}");

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        isTaskMoving = true;

        var args = new TaskMovedEventArgs
        {
            TaskId = taskId,
            FromColumnId = fromColumnId,
            ToColumnId = toColumnId
        };

        // –í—ã–∑—ã–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        await OnTaskMoved.InvokeAsync(args);

        // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
        _ = Task.Run(async () =>
        {
            await Task.Delay(300); // –î–∞–µ–º –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
            isTaskMoving = false;
            Console.WriteLine($"üéØ BLAZOR: –§–ª–∞–≥ isTaskMoving —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –∑–∞–¥–∞—á–∏ {taskId}");
        });

        Console.WriteLine($"‚úÖ BLAZOR: –°–æ–±—ã—Ç–∏–µ drop –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏ –ø–µ—Ä–µ–¥–∞–Ω–æ —Ä–æ–¥–∏—Ç–µ–ª—é");
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    private bool IsTaskEditing(string taskId)
    {
        return taskEditingStates.ContainsKey(taskId) && taskEditingStates[taskId];
    }

    private bool IsTaskSaving(string taskId)
    {
        return taskSavingStates.ContainsKey(taskId) && taskSavingStates[taskId];
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    private bool IsColumnEditing(string columnId)
    {
        return columnEditingStates.ContainsKey(columnId) && columnEditingStates[columnId];
    }

    private bool IsColumnSaving(string columnId)
    {
        return columnSavingStates.ContainsKey(columnId) && columnSavingStates[columnId];
    }

    // –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    private void StartEditingTask(KanbanTask task)
    {
        // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–æ–π –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if (currentEditingTaskId != null && currentEditingTaskId != task.Id)
        {
            CancelEditingTask(currentEditingTaskId);
        }

        currentEditingTaskId = task.Id;
        taskEditingStates[task.Id] = true;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        editingTaskTitles[task.Id] = task.Title ?? "";
        editingTaskDueDates[task.Id] = task.DueDate;
        
        StateHasChanged();
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        _ = Task.Run(async () =>
        {
            await Task.Delay(50);
            await InvokeAsync(async () =>
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("eval", $@"
                        setTimeout(() => {{
                            const titleInput = document.querySelector('#task-{task.Id} input[type=""text""]');
                            if (titleInput) {{
                                titleInput.focus();
                                titleInput.select();
                            }}
                        }}, 10);
                    ");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ input: {ex.Message}");
                }
            });
        });
    }

    private void CancelEditingTask(string taskId)
    {
        var task = GetTaskById(taskId);
        if (task == null) return;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        if (editingTaskTitles.ContainsKey(taskId))
        {
            editingTaskTitles[taskId] = task.Title;
        }
        
        if (editingTaskDueDates.ContainsKey(taskId))
        {
            editingTaskDueDates[taskId] = task.DueDate;
        }
        
        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (taskEditingStates.ContainsKey(taskId))
        {
            taskEditingStates[taskId] = false;
        }
        
        if (currentEditingTaskId == taskId)
        {
            currentEditingTaskId = null;
        }
        
        StateHasChanged();
    }

    private async Task SaveTaskChanges(KanbanTask task)
    {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if (IsTaskSaving(task.Id))
        {
            Console.WriteLine($"‚è≥ –ó–∞–¥–∞—á–∞ {task.Id} —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...");
            return;
        }

        var hasChanges = false;
        var validationErrors = new List<string>();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
        if (editingTaskTitles.ContainsKey(task.Id))
        {
            var newTitle = editingTaskTitles[task.Id]?.Trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
            if (string.IsNullOrEmpty(newTitle))
            {
                validationErrors.Add("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
            }
            else if (newTitle.Length > 200)
            {
                validationErrors.Add("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤");
            }
            else if (newTitle != task.Title)
            {
                task.Title = newTitle;
                hasChanges = true;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞—Ç–µ
        if (editingTaskDueDates.ContainsKey(task.Id))
        {
            var newDueDate = editingTaskDueDates[task.Id];
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã
            if (newDueDate.HasValue && newDueDate.Value.Date < DateTime.Today)
            {
                validationErrors.Add("–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º");
            }
            else if (newDueDate != task.DueDate)
            {
                task.DueDate = newDueDate;
                hasChanges = true;
            }
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        if (validationErrors.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", $"–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n{string.Join("\n", validationErrors)}");
            return; // –ù–µ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        if (hasChanges && OnTaskUpdate.HasDelegate)
        {
            Console.WriteLine($"üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á–∏ {task.Id}...");
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            taskSavingStates[task.Id] = true;
            StateHasChanged();
            
            try
            {
                await OnTaskUpdate.InvokeAsync(task);
                Console.WriteLine($"‚úÖ –ó–∞–¥–∞—á–∞ {task.Id} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø–µ—Ö–∞
                await ShowSuccessAnimation(task.Id);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ {task.Id}: {ex.Message}");
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                var originalTask = GetTaskById(task.Id);
                if (originalTask != null)
                {
                    editingTaskTitles[task.Id] = originalTask.Title;
                    editingTaskDueDates[task.Id] = originalTask.DueDate;
                }
            }
            finally
            {
                // –°–Ω–∏–º–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                taskSavingStates[task.Id] = false;
            }
        }
        
        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        CancelEditingTask(task.Id);
    }

    private KanbanTask? GetTaskById(string taskId)
    {
        foreach (var column in Columns)
        {
            var task = column.Tasks.FirstOrDefault(t => t.Id == taskId);
            if (task != null) return task;
        }
        return null;
    }

    // –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–ª–æ–Ω–æ–∫
    private void StartEditingColumn(KanbanColumn column)
    {
        // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–æ–π –∫–æ–ª–æ–Ω–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if (currentEditingColumnId != null && currentEditingColumnId != column.Id)
        {
            CancelEditingColumn(currentEditingColumnId);
        }

        // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏
        if (currentEditingTaskId != null)
        {
            CancelEditingTask(currentEditingTaskId);
        }

        currentEditingColumnId = column.Id;
        columnEditingStates[column.Id] = true;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        editingColumnTitles[column.Id] = column.Title ?? "";
        
        StateHasChanged();
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        _ = Task.Run(async () =>
        {
            await Task.Delay(50);
            await InvokeAsync(async () =>
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("eval", $@"
                        setTimeout(() => {{
                            const titleInput = document.querySelector('#column-{column.Id} input[type=""text""]');
                            if (titleInput) {{
                                titleInput.focus();
                                titleInput.select();
                            }}
                        }}, 10);
                    ");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ–∫—É—Å–∞ –Ω–∞ input –∫–æ–ª–æ–Ω–∫–∏: {ex.Message}");
                }
            });
        });
    }

    private void CancelEditingColumn(string columnId)
    {
        var column = GetColumnById(columnId);
        if (column == null) return;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (editingColumnTitles.ContainsKey(columnId))
        {
            editingColumnTitles[columnId] = column.Title;
        }
        
        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (columnEditingStates.ContainsKey(columnId))
        {
            columnEditingStates[columnId] = false;
        }
        
        if (currentEditingColumnId == columnId)
        {
            currentEditingColumnId = null;
        }
        
        StateHasChanged();
    }

    private async Task SaveColumnChanges(KanbanColumn column)
    {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if (IsColumnSaving(column.Id))
        {
            Console.WriteLine($"‚è≥ –ö–æ–ª–æ–Ω–∫–∞ {column.Id} —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...");
            return;
        }

        var hasChanges = false;
        var validationErrors = new List<string>();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
        if (editingColumnTitles.ContainsKey(column.Id))
        {
            var newTitle = editingColumnTitles[column.Id]?.Trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
            if (string.IsNullOrEmpty(newTitle))
            {
                validationErrors.Add("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
            }
            else if (newTitle.Length > 100)
            {
                validationErrors.Add("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 100 —Å–∏–º–≤–æ–ª–æ–≤");
            }
            else if (newTitle != column.Title)
            {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞
                var duplicateColumn = Columns.FirstOrDefault(c => c.Id != column.Id && 
                    string.Equals(c.Title?.Trim(), newTitle, StringComparison.OrdinalIgnoreCase));
                
                if (duplicateColumn != null)
                {
                    validationErrors.Add("–ö–æ–ª–æ–Ω–∫–∞ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
                }
                else
                {
                    column.Title = newTitle;
                    hasChanges = true;
                }
            }
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        if (validationErrors.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", $"–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n{string.Join("\n", validationErrors)}");
            return; // –ù–µ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        if (hasChanges && OnColumnUpdate.HasDelegate)
        {
            Console.WriteLine($"üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ {column.Id}...");
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            columnSavingStates[column.Id] = true;
            StateHasChanged();
            
            try
            {
                await OnColumnUpdate.InvokeAsync(column);
                Console.WriteLine($"‚úÖ –ö–æ–ª–æ–Ω–∫–∞ {column.Id} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø–µ—Ö–∞
                await ShowColumnSuccessAnimation(column.Id);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ {column.Id}: {ex.Message}");
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                var originalColumn = GetColumnById(column.Id);
                if (originalColumn != null)
                {
                    editingColumnTitles[column.Id] = originalColumn.Title;
                }
            }
            finally
            {
                // –°–Ω–∏–º–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                columnSavingStates[column.Id] = false;
            }
        }
        
        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        CancelEditingColumn(column.Id);
    }

    private KanbanColumn? GetColumnById(string columnId)
    {
        return Columns.FirstOrDefault(c => c.Id == columnId);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    private async Task HandleTitleKeyPress(KeyboardEventArgs e, KanbanTask task)
    {
        if (e.Key == "Enter")
        {
            await SaveTaskChanges(task);
        }
        else if (e.Key == "Escape")
        {
            CancelEditingTask(task.Id);
        }
    }

    private async Task SelectInputText(FocusEventArgs e)
    {
        // –í—ã–¥–µ–ª—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ input
        await JSRuntime.InvokeVoidAsync("eval", "event.target.select()");
    }

    private async Task HandleDateKeyPress(KeyboardEventArgs e, KanbanTask task)
    {
        if (e.Key == "Enter")
        {
            await SaveTaskChanges(task);
        }
        else if (e.Key == "Escape")
        {
            CancelEditingTask(task.Id);
        }
    }

    private async Task ClearTaskDate(KanbanTask task)
    {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –µ—Å–ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
        if (IsTaskSaving(task.Id))
        {
            return;
        }
        
        editingTaskDueDates[task.Id] = null;
        await SaveTaskChanges(task);
    }

    private string GetEditingTaskDueDateString(string taskId)
    {
        if (editingTaskDueDates.ContainsKey(taskId) && editingTaskDueDates[taskId].HasValue)
        {
            return editingTaskDueDates[taskId]!.Value.ToString("yyyy-MM-dd");
        }
        return "";
    }

    private void UpdateEditingTaskDueDate(string taskId, string? dateString)
    {
        if (string.IsNullOrEmpty(dateString))
        {
            editingTaskDueDates[taskId] = null;
        }
        else if (DateTime.TryParse(dateString, out DateTime parsedDate))
        {
            editingTaskDueDates[taskId] = parsedDate;
        }

        StateHasChanged();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
    private async Task HandleColumnTitleKeyPress(KeyboardEventArgs e, KanbanColumn column)
    {
        if (e.Key == "Enter")
        {
            await SaveColumnChanges(column);
        }
        else if (e.Key == "Escape")
        {
            CancelEditingColumn(column.Id);
        }
    }

    private async Task SelectColumnInputText(FocusEventArgs e)
    {
        // –í—ã–¥–µ–ª—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ input –∫–æ–ª–æ–Ω–∫–∏
        await JSRuntime.InvokeVoidAsync("eval", "event.target.select()");
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —É—Å–ø–µ—Ö–∞
    private async Task ShowSuccessAnimation(string taskId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", $@"
                const taskElement = document.getElementById('task-{taskId}');
                if (taskElement) {{
                    taskElement.classList.add('save-success');
                    setTimeout(() => {{
                        taskElement.classList.remove('save-success');
                    }}, 2000);
                }}
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —É—Å–ø–µ—Ö–∞: {ex.Message}");
        }
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —É—Å–ø–µ—Ö–∞ –∫–æ–ª–æ–Ω–∫–∏
    private async Task ShowColumnSuccessAnimation(string columnId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", $@"
                const columnElement = document.getElementById('column-{columnId}');
                if (columnElement) {{
                    columnElement.classList.add('save-success');
                    setTimeout(() => {{
                        columnElement.classList.remove('save-success');
                    }}, 2000);
                }}
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —É—Å–ø–µ—Ö–∞ –∫–æ–ª–æ–Ω–∫–∏: {ex.Message}");
        }
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    private string GetTagClasses(string tag)
    {
        return tag.ToLower() switch
        {
            "frontend" => "bg-blue-100 text-blue-800",
            "backend" => "bg-green-100 text-green-800",
            "bug" => "bg-red-100 text-red-800",
            "feature" => "bg-purple-100 text-purple-800",
            "urgent" => "bg-orange-100 text-orange-800",
            "design" => "bg-pink-100 text-pink-800",
            "testing" => "bg-yellow-100 text-yellow-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string GetDueDateClasses(DateTime dueDate)
    {
        var daysUntilDue = (dueDate.Date - DateTime.UtcNow.Date).Days;

        if (daysUntilDue < 0)
            return "text-red-600 font-medium"; // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
        else if (daysUntilDue == 0)
            return "text-orange-600 font-medium"; // –°–µ–≥–æ–¥–Ω—è
        else if (daysUntilDue == 1)
            return "text-yellow-600 font-medium"; // –ó–∞–≤—Ç—Ä–∞
        else
            return "text-gray-500"; // –û–±—ã—á–Ω–∞—è –¥–∞—Ç–∞
    }

    private string GetAssigneeColor(string assignee)
    {
        // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏
        var hash = assignee.GetHashCode();
        var colors = new[]
        {
"bg-blue-500", "bg-green-500", "bg-purple-500", "bg-pink-500",
"bg-indigo-500", "bg-red-500", "bg-yellow-500", "bg-teal-500"
};

        return colors[Math.Abs(hash) % colors.Length];
    }

    public async ValueTask DisposeAsync()
    {
        if (dotNetRef != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("kanbanDragDrop.cleanup");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå BLAZOR: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: {ex.Message}");
            }
            dotNetRef.Dispose();
        }
        await Task.CompletedTask;
    }

    // –ü—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ drag-and-drop (–¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑–≤–Ω–µ)
    public async Task RefreshDragAndDrop()
    {
        if (jsInteropDone && !isTaskMoving)
        {
            Console.WriteLine("üîÑ BLAZOR: –í–Ω–µ—à–Ω–∏–π –≤—ã–∑–æ–≤ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ drag-and-drop...");
            await ReinitializeDragAndDrop();
        }
        else if (isTaskMoving)
        {
            Console.WriteLine("‚è∏Ô∏è BLAZOR: –í–Ω–µ—à–Ω—è—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –∑–∞–¥–∞—á–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è");
        }
    }
}